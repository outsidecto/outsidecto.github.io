<!doctype html> <html lang=en> <head> <meta charset=utf-8 /> <meta http-equiv=X-UA-Compatible content='IE=edge;chrome=1'/> <meta name=viewport content="width=device-width, initial-scale=1, shrink-to-fit=no"> <title>OutsideCTO - Moving from WordPress to Middleman, Part II: Multiple categories per post</title> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/> <link href="../../../../assets/stylesheets/application-407bf47a.css" rel=stylesheet /> <link href="../../../../assets/stylesheets/syntax-a7a497f1.css" rel=stylesheet /> <link href="https://fonts.googleapis.com/css?family=Lato:400,700&display=swap" rel=stylesheet> <!--[if lt IE 9]><script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script><![endif]--> </head> <body> <nav class="navbar navbar-expand-lg navbar-dark bg-primary"> <a class=navbar-brand href="/">Outside CTO</a> <button class=navbar-toggler type=button data-toggle=collapse data-target="#navbarSupportedContent" aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation"> <span class=navbar-toggler-icon></span> </button> <div class="collapse navbar-collapse" id=navbarSupportedContent> <ul class="navbar-nav mr-auto"> <li class=nav-item> <a class=nav-link href="/about">About/Contact<span class=sr-only>(current)</span></a> </li> <li class=nav-item> <a class=nav-link href="/hipaa/hipaa-00000-index.html">HIPAA from Scratch (free)</a> </li> <li class=nav-item> <a class=nav-link href="/publickey">Key</a> </li> <li class=nav-item> <a class=nav-link href="/blog/">Blog</a> </li> </ul> <link href="//www.findberry.com/search/css/framebox.css" rel=stylesheet /> <script src="//www.findberry.com/search/js/jquery.min.js"></script> <script src="//www.findberry.com/search/js/findberryfx.js"></script> <script src="//www.findberry.com/search/js/findberry.framebox.js"></script> <form class="form-inline my-2 my-lg-0" title="Search Box" action="//www.findberry.com/search/" method=get id=sr_iframe> <input type=hidden name=wid value=12622 /> <input class="form-control-sm mr-sm-2" aria-label=Search id=sr_searchbox name=query size=35 /> <input class="btn btn-outline-success my-2 my-sm-0" id=sr_searchbutton type=submit value=Search /> </form> </div> </nav> <div class="container-fluid pt-5 px-5"> <h1>Moving from WordPress to Middleman, Part II: Multiple categories per post <small> by jgn on Thursday, February 5, 2015 in <a href="../../../../category/technology/">Technology</a>, <a href="../../../../category/ruby/">Ruby</a>, and <a href="../../../../category/middleman/">Middleman</a> </small> </h1> <p><br/></p> <table><thead> <tr> <th>NOTE</th> </tr> </thead><tbody> <tr> <td>This technique is obsolete; see <a href="../../../2018/05/a-middleman-extension-for-categories/">A Middleman Extension for Categories</a></td> </tr> </tbody></table> <p><br/></p> <p>One oddity of <a href="https://middlemanapp.com">Middleman</a> and its <a href="https://middlemanapp.com/basics/blogging/">blog template</a> is that its model for additional metadata is a bit weak. The documentation tells us that you can have &quot;Custom Article Collections.&quot; The example they give is for a &quot;category&quot; but you can really only have one value per category attribute. In other words, you can&#39;t have multiple categories separated with a comma, which is the pattern for tags. My old WordPress blog had multiple categories per post, with nice pages listing all posts by a given category. I&#39;d like to keep those pages working. But without a strategy for multiple categories per post, I can&#39;t refresh my old blog as I&#39;d like.</p> <p>So how to fix this? It would be possible to create an extension that imitates the &quot;tag&quot; support, but the class organization looks fairly complicated, and I&#39;m not sanguine about writing an extension only to see that the class structure changes and my code starts to fail.</p> <p>Another way to do this is with global helper methods. This has the downside of polluting the global space. But it has the benefit of being obvious. So here&#39;s what I did.</p> <p>First I created a sample blog with a couple of articles.</p> <div class=highlight><pre class="highlight shell"><code>middleman init middleman-with-multiple-categories-per-post <span class="nt">--template</span><span class="o">=</span>blog
<span class="nb">cd </span>middleman-with-multiple-categories-per-post
middleman article <span class="s1">'"Going to Boston by plane"'</span>
middleman article <span class="s1">'"Going to Chicago by train"'</span>
</code></pre></div> <p>In this case, I want both articles to be in the category &quot;Travel&quot; while the Boston trip is also in the category &quot;Boston&quot; and the Chicago trip is also in the category &quot;Chicago.&quot; So for the first article, I hand edit the front matter to look like this:</p> <div class=highlight><pre class="highlight yaml"><code><span class="nn">---</span>
<span class="na">title</span><span class="pi">:</span> <span class="s">Going to Boston by plane</span>
<span class="na">date</span><span class="pi">:</span> <span class="s">2015-02-05 01:35 UTC</span>
<span class="na">tags</span><span class="pi">:</span>
<span class="na">categories</span><span class="pi">:</span> <span class="s">Travel, Boston</span>
<span class="nn">---</span>
</code></pre></div> <p>Now, let&#39;s work outside-in. In my <code>layout.erb</code> I am going to want to be able to list out all of my categories. The code is going to look something like this:</p> <div class=highlight><pre class="highlight html"><code><span class="nt">&lt;h2&gt;</span>Categories<span class="nt">&lt;/h2&gt;</span>
<span class="nt">&lt;ul&gt;</span>
  <span class="nt">&lt;</span><span class="err">%</span> <span class="na">all_categories.each</span> <span class="na">do</span> <span class="err">|</span><span class="na">category</span><span class="err">,</span> <span class="na">articles</span><span class="err">|</span> <span class="err">%</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;&lt;</span><span class="err">%=</span> <span class="na">link_to</span> <span class="err">"</span><span class="na">#</span><span class="err">{</span><span class="na">category</span><span class="err">}</span> <span class="err">(</span><span class="na">#</span><span class="err">{</span><span class="na">articles.size</span><span class="err">})",</span> <span class="na">category_path</span><span class="err">(</span><span class="na">category</span><span class="err">)</span> <span class="err">%</span><span class="nt">&gt;&lt;/li&gt;</span>
  <span class="nt">&lt;</span><span class="err">%</span> <span class="na">end</span> <span class="err">%</span><span class="nt">&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre></div> <p><code>all_categories</code> and <code>category_path</code> are the methods I need. <code>all_categories</code> is going to return a Hash where each key is a category name, and each value is the collection of articles that are defined under that key. <code>category_path</code> is going to return a dasherized all-lower-case URL for that category. If we add this chunk into our <code>layout.erb</code> right before our display of tags, it will fail, so let&#39;s implement the methods as helpers.</p> <p>Here&#39;s one way to do it. Put this in <code>config.rb</code>:</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">helpers</span> <span class="k">do</span>
  <span class="k">def</span> <span class="nf">categories</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
    <span class="n">category_array</span><span class="p">(</span><span class="n">page</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="ss">:categories</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">category_path</span><span class="p">(</span><span class="n">category</span><span class="p">)</span>
    <span class="s2">"/category/</span><span class="si">#{</span><span class="n">category</span><span class="p">.</span><span class="nf">parameterize</span><span class="si">}</span><span class="s2">.html"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">all_categories</span>
    <span class="vi">@all_categories</span> <span class="o">||=</span> <span class="no">Hash</span><span class="p">[</span><span class="n">all_categories_unsorted</span><span class="p">.</span><span class="nf">sort</span><span class="p">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">category_array</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
    <span class="p">(</span><span class="n">categories</span> <span class="o">||</span> <span class="s2">"Uncategorized"</span><span class="p">).</span><span class="nf">split</span><span class="p">(</span><span class="sr">/,\s*/</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">all_categories_unsorted</span>
    <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span> <span class="p">{</span> <span class="p">[]</span> <span class="p">}.</span><span class="nf">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">all_categories</span><span class="o">|</span>
      <span class="n">blog</span><span class="p">.</span><span class="nf">articles</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">article</span><span class="o">|</span>
        <span class="n">categories</span><span class="p">(</span><span class="n">article</span><span class="p">).</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">ac</span><span class="o">|</span>
          <span class="n">all_categories</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="n">article</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>The magic here is in the private method <code>all_categories_unsorted</code> and the fragment <code>blog.articles</code>. When the static page is rendered, Middleman exposes the <code>blog</code> method which has an attribute <code>articles</code> that you can iterate through. What we are doing here is building up the Hash of key/value pairs, each representing a category and the collection of all articles referencing it (by the way, another way to build up this Hash is to use <code>inject</code> but I like this way). <code>Hash.new { [] }</code> is using a block to say that the default value of a Hash entry should be a new Array; and the <code>&lt;&lt;=</code> operator provides for initializing the Hash value as the empty Array if there is no value already; if there is a value, we append (<code>&lt;&lt;</code>) our new article). That&#39;s just Ruby 101, right? Meanwhile, it would be nice to sort the Hash by key value. To do that, we leverage the <code>all_categories_unsorted</code> method with a public one called <code>all_categories</code> that does the sort (you should be able to figure out the <code>Hash[all_categories_unsorted.sort]</code> idiom).</p> <p>The value for the <code>categories</code> metadata tag is taken apart by the method <code>categories</code> which takes the value from the page (e.g., &quot;Travel, Chicago&quot;) and splits it up into an Array. As a nicety, when no category is specified, we use a default of &quot;Uncategorized&quot; -- this made it a little easier to migrate my old WordPerfect blog which had a few posts without categories. To get <code>category_path</code> to come out right, we use the <code>parameterize</code> method which does the dasherizing / lowercasing for us -- it&#39;s a standard part of Middleman, because it is a standard part of <a href="http://www.padrinorb.com">Padrino</a>, which supplies the view helpers.</p> <p>So that actually looks pretty good. You&#39;ll see a nice list of categories.</p> <p>Unfortunately the links go nowhere. If you click on a link you&#39;ll get a &quot;file not found.&quot; Oops. Let&#39;s fix that.</p> <p>Middleman provides a hook to do extra stuff afer &quot;all loading and parsing of extensions is complete&quot; (I know this because I read the source). It&#39;s referenced though not really explained in the discussion of the <a href="https://middlemanapp.com/advanced/sitemap/">Middleman Sitemap</a>.</p> <p>We define our ready method in <code>config.rb</code>:</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">ready</span> <span class="k">do</span>
  <span class="n">sitemap</span><span class="p">.</span><span class="nf">resources</span>
    <span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span> <span class="n">category_array</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="nf">data</span><span class="p">[</span><span class="s2">"categories"</span><span class="p">])</span> <span class="p">}</span>
    <span class="p">.</span><span class="nf">flatten</span>
    <span class="p">.</span><span class="nf">uniq</span>
    <span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">category</span><span class="o">|</span>
    <span class="n">proxy</span> <span class="n">category_path</span><span class="p">(</span><span class="n">category</span><span class="p">),</span> <span class="s2">"category.html"</span><span class="p">,</span> <span class="ss">locals: </span><span class="p">{</span> <span class="ss">category: </span><span class="n">category</span> <span class="p">}</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p>Here we go through all of the resources, and grab the value for each occurrence of &quot;categories&quot; - and we make a little array out of that with our helper method <code>category_array</code>. Then we flatten it to make one big Array, uniq it, and then we use Middleman&#39;s <code>proxy</code> method to tie the incoming request for a path to a template file (which we will create in a moment). Notice that to get the path for the incoming category we leverage the same <code>category_path</code> helper we used from <code>layout.erb</code> and defined above.</p> <p>Now all we need is <code>category.html.erb</code>. Here&#39;s what it looks like (put this in <code>source/</code>):</p> <div class=highlight><pre class="highlight html"><code><span class="nt">&lt;h1&gt;</span>Articles in category '<span class="nt">&lt;</span><span class="err">%=</span> <span class="na">category</span> <span class="err">%</span><span class="nt">&gt;</span>'<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul&gt;</span>
  <span class="nt">&lt;</span><span class="err">%</span> <span class="na">all_categories</span><span class="err">[</span><span class="na">category</span><span class="err">].</span><span class="na">each_with_index</span> <span class="na">do</span> <span class="err">|</span><span class="na">article</span><span class="err">,</span> <span class="na">i</span><span class="err">|</span> <span class="err">%</span><span class="nt">&gt;</span>
    <span class="nt">&lt;li&gt;&lt;</span><span class="err">%=</span> <span class="na">link_to</span> <span class="na">article.title</span><span class="err">,</span> <span class="na">article</span> <span class="err">%</span><span class="nt">&gt;</span> <span class="nt">&lt;span&gt;</span>(<span class="nt">&lt;</span><span class="err">%=</span> <span class="na">article.date.strftime</span><span class="err">('%</span><span class="na">B</span> <span class="err">%</span><span class="na">e</span><span class="err">,</span> <span class="err">%</span><span class="na">Y</span><span class="err">')</span> <span class="err">%</span><span class="nt">&gt;</span>)<span class="nt">&lt;/span&gt;&lt;/li&gt;</span>
  <span class="nt">&lt;</span><span class="err">%</span> <span class="na">end</span> <span class="err">%</span><span class="nt">&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</code></pre></div> <p>We&#39;re almost done. There is one last thing. If you try to build your static blog with <code>middleman build</code>, it will fail, because Middleman will try to render the <code>category.html.erb</code> template which we are only using for our proxies (it fails because it can&#39;t find the <code>category</code> local variable, which we have been injecting into the page by the proxy). To not render the raw page, add an ignore call in your <code>configure</code> block for <code>:build</code> - like so (I omitted a bunch of comments):</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">configure</span> <span class="ss">:build</span> <span class="k">do</span>
  <span class="n">ignore</span> <span class="s1">'/category.html'</span>
<span class="k">end</span>
</code></pre></div> <p>A repo with commits for each code block above is at <a href="https://github.com/jgn/middleman-with-multiple-categories-per-post">https://github.com/jgn/middleman-with-multiple-categories-per-post</a>.</p> <div id=disqus_thread></div> <script>
//<![CDATA[
                  var disqus_shortname = 'outsidecto';
          
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
//]]>
</script> <noscript>Please enable JavaScript to view the <a href='http://disqus.com/?ref_noscript'>comments powered by Disqus.</a></noscript> <a href='http://disqus.com' class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> <script>
//<![CDATA[
    var disqus_shortname = 'outsidecto';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
//]]>
</script> </div> <hr/> <div class="container-fluid footer-padding px-5"> <aside> <h4>Recent Posts</h4> <ol> <li><a href="../../../2018/05/a-middleman-extension-for-categories/">A Middleman Extension for Categories</a> <span>(May 26, 2018)</span></li> <li><a href="../../../2018/03/hansen-great-at-work-how-top-performers-do-less-work-better-and-achieve-more-book-review/">Hansen, Great at Work&#58; How Top Performers Do Less, Work Better, and Achieve More (Book Review)</a> <span>(March 3, 2018)</span></li> <li><a href="../../../2018/02/transitioning-to-programming/">Transitioning to being a Programmer</a> <span>(February 18, 2018)</span></li> <li><a href="../../../2018/02/values/">Values</a> <span>(February 10, 2018)</span></li> <li><a href="../../../2017/09/fournier-the-manager-s-path-a-guide-for-tech-leaders-navigating-growth-and-change-book-review/">Fournier, The Manager's Path&#58; A Guide for Tech Leaders Navigating Growth and Change (Book Review)</a> <span>(September 2, 2017)</span></li> <li><a href="../../../2017/08/sutherland-scrum-the-art-of-doing-twice-the-work-in-half-the-time-book-review/">Sutherland, Scrum&#58; The Art of Doing Twice the Work in Half the Time (Book Review)</a> <span>(August 25, 2017)</span></li> </ol> <h4>Categories</h4> <a href="../../../../category/code/" class="btn btn-default btn-xs">Code <span class='badge badge-secondary'>4</span></a> <a href="../../../../category/iora/" class="btn btn-default btn-xs">Iora <span class='badge badge-secondary'>1</span></a> <a href="../../../../category/kendall-square/" class="btn btn-default btn-xs">Kendall Square <span class='badge badge-secondary'>1</span></a> <a href="../../../../category/management/" class="btn btn-default btn-xs">Management <span class='badge badge-secondary'>1</span></a> <a href="../../../../category/middleman/" class="btn btn-default btn-xs">Middleman <span class='badge badge-secondary'>3</span></a> <a href="../../../../category/rails/" class="btn btn-default btn-xs">Rails <span class='badge badge-secondary'>2</span></a> <a href="../../../../category/reading/" class="btn btn-default btn-xs">Reading <span class='badge badge-secondary'>14</span></a> <a href="../../../../category/reviews/" class="btn btn-default btn-xs">Reviews <span class='badge badge-secondary'>17</span></a> <a href="../../../../category/ruby/" class="btn btn-default btn-xs">Ruby <span class='badge badge-secondary'>6</span></a> <a href="../../../../category/startup-cto-bookshelf/" class="btn btn-default btn-xs">Startup CTO Bookshelf <span class='badge badge-secondary'>2</span></a> <a href="../../../../category/teaching/" class="btn btn-default btn-xs">Teaching <span class='badge badge-secondary'>1</span></a> <a href="../../../../category/technology/" class="btn btn-default btn-xs">Technology <span class='badge badge-secondary'>17</span></a> <a href="../../../../category/uncategorized/" class="btn btn-default btn-xs">Uncategorized <span class='badge badge-secondary'>3</span></a> <a href="../../../../category/values/" class="btn btn-default btn-xs">Values <span class='badge badge-secondary'>1</span></a> <h4>Tags</h4> <a href="/tag/activerecord/" class="btn btn-default btn-xs">activerecord <span class='badge badge-secondary'>1</span></a> <a href="/tag/categories/" class="btn btn-default btn-xs">categories <span class='badge badge-secondary'>1</span></a> <a href="/tag/ruby/" class="btn btn-default btn-xs">ruby <span class='badge badge-secondary'>2</span></a> <a href="/tag/wordpress/" class="btn btn-default btn-xs">wordpress <span class='badge badge-secondary'>2</span></a> <hr/> Check accessibility with <a href="//wave.webaim.org/refer">WAVE</a>. </aside> </div> <footer class=footer> <small style="line-height: 0.8;"> <i>Disclaimer: The views and and opinions expressed in this text belong solely to Outside CTO, LLC, and not to any other group or individual, past, present, or future. No liability is accepted. What is written here does not constitute legal advice. Use at your own risk.</i> &nbsp;&nbsp;&nbsp;&nbsp;&copy; 2007-2024&nbsp;&nbsp;&nbsp;&nbsp;Outside CTO, LLC&nbsp;&nbsp;&nbsp;&nbsp;All Rights Reserved. </small> </footer> <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin=anonymous></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity=sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1 crossorigin=anonymous></script> <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin=anonymous></script> <script src="../../../../assets/javascripts/all-ce8a433c.js"></script> <script>
    $(function() {
      $('input[type="checkbox"]').each(function() {
        var pathname = document.location.pathname;
        var key = pathname + $(this).prop("id");
        $(this).prop("checked", localStorage.getItem(key) == "true");

        $(this).bind("click", function() {
          var pathname = document.location.pathname;
          var key = pathname + $(this).prop("id");
          localStorage.setItem(key, $(this).prop("checked"));
        });
      })
    });
  </script> </body> </html>